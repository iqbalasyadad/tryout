{% extends "core/base.html" %}
{% block title %}Player | {{ attempt.package.title }}{% endblock %}

{% block content %}
<style>
  .layout { display:flex; gap:16px; align-items:flex-start; }
  .sidebar { width:280px; border:1px solid #ddd; padding:12px; border-radius:5px; }
  .main { flex:1; border:1px solid #ddd; padding:16px; border-radius:5px; }

  .grid { display:grid; grid-template-columns: repeat(5, 1fr); gap:1px; }
  .qbtn { display:flex; align-items:center; justify-content:center; height:30px; border-radius:1px; border:1px solid #ccc; text-decoration:none; font-weight:600; }

  .blank { background:#ff0000; border-color:#ff0000; color:#ffffff; }       /* merah */
  .answered { background:#02c248; border-color:#02c248; color:#ffffff; }   /* hijau */
  .flagged { background:#e7b900; border-color:#e7b900; color:#ffffff; }    /* kuning */
  .current { background:#0765f3; border-color:#0765f3; color:#ffffff; }    /* biru */

  .option { border:1px solid #ddd; padding:12px; border-radius:5px; margin-bottom:10px; }
  .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .pill { border:1px solid #ddd; padding:6px 10px; border-radius:5px; }
  .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
</style>

<div class="topbar">
  <div>
    <b>{{ attempt.package.title }}</b><br>
    <small>Mode: {{ attempt.mode }} | Soal {{ idx|add:1 }} dari {{ counts.total }}</small>
  </div>
  <div class="pill">
    Waktu tersisa:
    <b id="timer">{{ time_info.remaining_seconds }}</b> detik
  </div>
</div>

<div class="layout">
  <aside class="sidebar">
    <h3 style="margin-top:0;">Navigasi</h3>

    <div style="font-size:12px; line-height:1.6; margin-bottom:10px;">
      <!-- <div>üü• Blank: {{ counts.blank }}</div>
      <div>üü© Answered: {{ counts.answered }}</div>
      <div>üü® Flagged: {{ counts.flagged }}</div>
      <div>Total: {{ counts.total }}</div> -->
      <div>üü• Blank: {{ counts.blank }} üü© Answered: {{ counts.answered }} üü® Flagged: {{ counts.flagged }}</div>
    </div>

    <div class="grid">
      {% for g in grid %}
        <button
          type="submit"
          form="answer-form"
          class="qbtn {{ g.status }}"
          name="jump"
          value="{{ g.idx }}"
          style="cursor:pointer;"
        >
          {{ g.num }}
        </button>
      {% endfor %}
    </div>
    <br>
    <div>
      <button
        type="submit"
        form="answer-form"
        name="action"
        value="submit"
      >
        Finish / Submit
      </button>
    </div>

  </aside>

  <section class="main">
    <h2 style="margin-top:0;">Soal Nomor {{ idx|add:1 }}</h2>
    {% if current_question.section %}
      <div style="color:#2f6bff; font-weight:600; margin-bottom:10px;">
        {{ current_question.section.title }}
      </div>
    {% endif %}

    <div style="margin-bottom:14px;">
      <div style="white-space:pre-line;">{{ current_question.stem }}</div>

      {% if current_question.image %}
        <div style="margin-top:10px;">
          <img src="{{ current_question.image.url }}" style="max-width:100%; border-radius:10px; border:1px solid #eee;">
        </div>
      {% endif %}

      {% if current_question.audio %}
        <div style="margin-top:10px;">
          <audio controls src="{{ current_question.audio.url }}" style="width:100%;"></audio>
        </div>
      {% endif %}
    </div>

    <form method="post" id="answer-form">
      {% csrf_token %}

      {% if is_multi %}
        <!-- <input type="hidden" name="action" value="save"> -->
        {% for c in current_question.choices.all %}
          <label class="option" style="display:block; cursor:pointer;">
            <input type="checkbox" name="choice" value="{{ c.id }}"
                   {% if c.id in selected_ids %}checked{% endif %}>
            {{ c.label }}. {{ c.text }}
          </label>
        {% endfor %}
      {% else %}
        <!-- <input type="hidden" name="action" value="save"> -->
        {% for c in current_question.choices.all %}
          <label class="option" style="display:block; cursor:pointer;">
            <input type="radio" name="choice" value="{{ c.id }}"
                   {% if c.id in selected_ids %}checked{% endif %}>
            {{ c.label }}. {{ c.text }}
          </label>
        {% endfor %}
      {% endif %}

      <div class="actions">
        <button type="submit" name="nav" value="prev">‚Üê Prev</button>
        <button type="submit" name="action" value="clear">Clear Answer</button>
        <button type="submit" name="action" value="toggle_flag">
            {% if answer_obj.flagged %}Unflag{% else %}Flag question{% endif %}
        </button>
        <button type="submit" name="nav" value="next">Next ‚Üí</button>

        <!-- <button type="submit" name="action" value="submit">Submit</button> -->
      </div>
      
    </form>
  </section>
</div>
<script>
  (function(){
    const form = document.getElementById("answer-form");
    if(!form) return;

    const idx = "{{ idx }}";
    const url = "{% url 'attempt_autosave' attempt.id %}";
    const csrftoken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

    let t = null;
    function autosave(){
      const fd = new FormData(form);
      fd.set("idx", idx);

      fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: fd
      }).then(r => r.json()).then(data => {
        // optional: tampilkan indikator "tersimpan"
        // console.log(data);
      }).catch(() => {});
    }

    form.addEventListener("change", (e) => {
      if (e.target && e.target.name === "choice") {
        clearTimeout(t);
        t = setTimeout(autosave, 250); // debounce
      }
    });
  })();
</script>


<script>
  // countdown visual (server tetap sumber kebenaran)
  (function(){
    let s = parseInt(document.getElementById("timer").textContent || "0", 10);
    const el = document.getElementById("timer");
    setInterval(() => {
      if (s > 0) s -= 1;
      el.textContent = String(s);
    }, 1000);
  })();
</script>
{% endblock %}
